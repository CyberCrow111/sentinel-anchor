<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Sentinel Anchor â€” Crow-Tech Ops Hub</title>
  <meta name="description" content="Crow-Tech Sentinel Anchor: command palette, multi-engine search, launchpad, pins, missions, notes. Built for low energy, high leverage." />
  <meta name="theme-color" content="#060812"/>

  <style>
    :root{
      --bg:#060812;
      --panel:rgba(10,14,26,.82);
      --panel2:rgba(8,11,22,.68);
      --stroke:rgba(160,190,255,.14);
      --stroke2:rgba(160,190,255,.22);
      --text:#EAF1FF;
      --muted:rgba(210,225,255,.72);
      --accent:#72B7FF;
      --accent2:#7CFFDD;
      --danger:#FF4D7D;
      --good:#78FF9A;
      --warn:#FFD36E;

      --r:18px;
      --r2:14px;
      --shadow: 0 18px 60px rgba(0,0,0,.52);
      --glow: 0 0 26px rgba(114,183,255,.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 25% -10%, rgba(114,183,255,.28), transparent 62%),
        radial-gradient(900px 620px at 90% 0%, rgba(124,255,221,.14), transparent 60%),
        radial-gradient(1200px 900px at 60% 120%, rgba(114,183,255,.10), transparent 65%),
        linear-gradient(180deg, #060812 0%, #070A12 55%, #060812 100%);
      overflow-x:hidden;
    }

    /* Subtle scanlines */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          180deg,
          rgba(255,255,255,.03) 0px,
          rgba(255,255,255,.03) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 6px
        );
      opacity:.10;
      mix-blend-mode:overlay;
    }

    .wrap{max-width:1160px; margin:0 auto; display:flex; flex-direction:column; gap:14px;}

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(114,183,255,.09), transparent 22%), var(--panel);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card:after{
      content:"";
      position:absolute; inset:-2px;
      border-radius:var(--r);
      pointer-events:none;
      background:
        radial-gradient(600px 140px at 20% 0%, rgba(124,255,221,.12), transparent 70%),
        radial-gradient(600px 160px at 85% 0%, rgba(114,183,255,.14), transparent 70%);
      opacity:.9;
    }
    .card > *{position:relative; z-index:1}

    .top{padding:16px; display:flex; flex-direction:column; gap:10px}
    .topRow{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{margin:0; font-size:1.55rem; letter-spacing:.4px}
    .sub{margin:0; color:var(--muted); line-height:1.35}

    .badges{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .badge{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      padding:6px 10px;
      border-radius:999px;
      font-size:.85rem;
      color:var(--accent);
      display:flex; align-items:center; gap:8px;
      box-shadow: var(--glow);
    }
    .dot{width:9px; height:9px; border-radius:50%; background:var(--good); box-shadow:0 0 14px rgba(120,255,154,.45);}
    .dot.warn{background:var(--warn); box-shadow:0 0 14px rgba(255,211,110,.35);}
    .dot.bad{background:var(--danger); box-shadow:0 0 14px rgba(255,77,125,.35);}

    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(114,183,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 0 20px rgba(114,183,255,.12);
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background: rgba(0,0,0,.22)}
    .btn.danger{background: rgba(255,77,125,.12); border-color: rgba(255,77,125,.45)}
    .btn.good{background: rgba(120,255,154,.10); border-color: rgba(120,255,154,.40)}

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr;} }

    .section{padding:14px}
    .head{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:10px}
    .head h2{margin:0; font-size:1.05rem; color:var(--accent); letter-spacing:.2px}
    .pill{
      font-size:.78rem;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color:var(--muted);
      padding:4px 10px;
      border-radius:999px;
    }

    .searchBox{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      background: var(--panel2);
      border:1px solid var(--stroke);
      padding:10px;
      border-radius: var(--r2);
    }
    input[type="text"], select, textarea{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.30);
      color:var(--text);
      border-radius: 14px;
      outline:none;
      font-size:1rem;
    }
    input[type="text"]{flex:1 1 220px; padding:12px}
    select{padding:12px 10px}
    textarea{width:100%; min-height:210px; resize:vertical; padding:12px; line-height:1.45}

    .tiny{margin:10px 0 0; color:var(--muted); font-size:.9rem; line-height:1.45}

    .tiles{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;}
    @media (max-width: 560px){ .tiles{grid-template-columns: 1fr 1fr;} }

    .tile{
      text-decoration:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color:var(--text);
    }
    .tile:hover{border-color: rgba(124,255,221,.45); box-shadow: 0 0 18px rgba(124,255,221,.10);}
    .tag{color:var(--muted); font-size:.78rem}

    hr{border:0; border-top:1px solid var(--stroke); margin:14px 0}

    .list{display:flex; flex-direction:column; gap:8px}
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      padding:10px 12px;
      border-radius: 14px;
    }
    .itemTitle{font-weight:900}
    .itemMeta{color:var(--muted); font-size:.85rem}
    .itemBtns{display:flex; gap:8px; flex-wrap:wrap}

    .saveLine{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-size:.9rem; margin-top:10px;
    }
    .miniPill{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color:var(--muted);
      padding:4px 10px;
      border-radius:999px;
      font-size:.82rem;
    }

    /* Command Palette modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(900px, 100%);
      margin-top:40px;
      border:1px solid var(--stroke2);
      border-radius: 18px;
      background: rgba(7,10,18,.96);
      box-shadow: 0 22px 70px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalTop{
      display:flex; gap:10px; align-items:center;
      padding:12px;
      border-bottom:1px solid var(--stroke);
    }
    .modalTop input{
      flex:1;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.32);
      color: var(--text);
    }
    .modalBody{
      max-height: 60vh;
      overflow:auto;
      padding:10px;
    }
    .cmd{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      border-radius: 14px;
      padding:12px;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      cursor:pointer;
      margin-bottom:10px;
    }
    .cmd:hover{border-color: rgba(114,183,255,.55)}
    .cmdName{font-weight:900}
    .cmdDesc{color:var(--muted); font-size:.86rem}

    .footer{
      text-align:center;
      color: rgba(210,225,255,.55);
      font-size:.85rem;
      padding:10px 0 4px;
    }

    /* Focus Mode */
    .focus .notFocus{display:none !important;}

    .diag{
      border:1px dashed rgba(124,255,221,.35);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:10px 12px;
      color: var(--muted);
      font-size:.9rem;
    }
    .diag b{color: var(--accent2)}
  </style>
</head>

<body>
  <div class="wrap" id="app">

    <div class="card top">
      <div class="topRow">
        <div>
          <h1>Sentinel Anchor</h1>
          <p class="sub">Crow-Tech Ops Hub: command palette + multi-engine search + launchpad + pins + missions + notes. Static + strong.</p>
        </div>

        <div class="actions">
          <button class="btn" id="btnCommand" type="button">âš¡ Command</button>
          <button class="btn secondary" id="btnFocus" type="button">ðŸŽ¯ Focus</button>
          <button class="btn secondary" id="btnCopyUrl" type="button">ðŸ”— Copy URL</button>
          <button class="btn danger notFocus" id="btnLocalReset" type="button">ðŸ§¹ Reset Local</button>
        </div>
      </div>

      <div class="badges">
        <span class="badge"><span class="dot" id="statusDot"></span> Status: <span id="statusText">Online</span></span>
        <span class="badge">Mode: Operator</span>
        <span class="badge">Node: Sentinel Anchor</span>
        <span class="badge" id="clockBadge">Time: â€”</span>
        <span class="badge" id="jsBadge">JS: Bootingâ€¦</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card section" id="left">
        <div class="head">
          <h2>Search Console</h2>
          <span class="pill">Enter = search Â· Bangs supported</span>
        </div>

        <div class="searchBox">
          <input id="q" type="text" placeholder="Examples: 'android automation' | '!gh sentinel-anchor' | '!r best weather radar app'" autocomplete="off" />
          <select id="engine" aria-label="Search engine">
            <option value="google">Google</option>
            <option value="ddg">DuckDuckGo</option>
            <option value="brave">Brave Search</option>
            <option value="reddit">Reddit</option>
            <option value="youtube">YouTube</option>
            <option value="github">GitHub</option>
            <option value="wikipedia">Wikipedia</option>
          </select>
          <button class="btn good" id="btnSearch" type="button">Search</button>
        </div>

        <p class="tiny notFocus">
          <b>Bangs:</b>
          <span class="miniPill">!g</span> <span class="miniPill">!ddg</span> <span class="miniPill">!br</span>
          <span class="miniPill">!r</span> <span class="miniPill">!yt</span> <span class="miniPill">!gh</span> <span class="miniPill">!w</span>
          (Example: <b>!gh weather command center</b>)
        </p>

        <hr>

        <div class="head">
          <h2>Quick Launch</h2>
          <span class="pill">editable tiles</span>
        </div>

        <div class="tiles" id="quickTiles"></div>

        <div class="actions notFocus" style="margin-top:10px">
          <button class="btn secondary" id="btnEditTiles" type="button">ðŸ§© Edit Launch Tiles</button>
        </div>

        <hr class="notFocus">

        <div class="head notFocus">
          <h2>Mission Slots</h2>
          <span class="pill">local list</span>
        </div>
        <div class="list notFocus" id="missionList"></div>
        <div class="actions notFocus" style="margin-top:10px">
          <button class="btn secondary" id="btnAddMission" type="button">âž• Add mission</button>
          <button class="btn danger" id="btnClearMissions" type="button">Clear missions</button>
        </div>

        <hr class="notFocus">

        <div class="head notFocus">
          <h2>Search History</h2>
          <span class="pill">local</span>
        </div>
        <div class="list notFocus" id="historyList"></div>
        <div class="actions notFocus" style="margin-top:10px">
          <button class="btn secondary" id="btnClearHistory" type="button">Clear history</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card section" id="right">
        <div class="head">
          <h2>Notes / Journal</h2>
          <span class="miniPill" id="noteState">Ready</span>
        </div>

        <textarea id="notes" placeholder="Drop anything here. Auto-saves on this device. Use Daily when the brain is tired."></textarea>

        <div class="saveLine">
          <div>Last saved: <b id="lastSaved">â€”</b></div>
          <div class="actions">
            <button class="btn secondary" id="btnStamp" type="button">ðŸ•’ Stamp</button>
            <button class="btn secondary" id="btnDaily" type="button">ðŸ“… Daily</button>
            <button class="btn secondary" id="btnExport" type="button">Export</button>
            <button class="btn secondary" id="btnImport" type="button">Import</button>
            <button class="btn danger" id="btnClearNotes" type="button">Clear</button>
          </div>
        </div>

        <hr>

        <div class="head">
          <h2>My Links (editable)</h2>
          <span class="pill">on-device</span>
        </div>
        <div class="list" id="pinList"></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn secondary" id="btnAddPin" type="button">âž• Add link</button>
          <button class="btn danger" id="btnClearPins" type="button">Clear links</button>
        </div>

        <hr class="notFocus">

        <div class="head notFocus">
          <h2>Control Panel</h2>
          <span class="pill">always on</span>
        </div>
        <div class="list notFocus">
          <div class="item">
            <div>
              <div class="itemTitle">Repo (Forge)</div>
              <div class="itemMeta">github.com/CyberCrow111/sentinel-anchor</div>
            </div>
            <div class="itemBtns">
              <button class="btn secondary" id="btnOpenRepo" type="button">Open</button>
            </div>
          </div>
          <div class="item">
            <div>
              <div class="itemTitle">Public Site (Artifact)</div>
              <div class="itemMeta">cybercrow111.github.io/sentinel-anchor/</div>
            </div>
            <div class="itemBtns">
              <button class="btn secondary" id="btnOpenSite" type="button">Open</button>
            </div>
          </div>
        </div>

        <hr class="notFocus">

        <div class="diag notFocus" id="diagBox">
          <b>Diagnostics:</b> If Command/Search stop working, itâ€™s usually a JS error or cached old page.
          This build shows JS status up top as <b>JS: OK</b> when healthy. If itâ€™s stuck, hard refresh or open in a private tab.
        </div>
      </div>
    </div>

    <div class="footer">Crow-Tech Sentinel Anchor Â· Static + strong Â· built for power users</div>
  </div>

  <!-- Command Palette -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Command Palette">
      <div class="modalTop">
        <input id="cmdInput" type="text" placeholder="Commands: search Â· focus Â· tiles Â· pins Â· missions Â· notes Â· weather Â· radarâ€¦" autocomplete="off" />
        <button class="btn secondary" id="btnClosePalette" type="button">Esc</button>
      </div>
      <div class="modalBody" id="cmdList"></div>
      <div style="padding: 0 12px 12px; color: var(--muted); font-size:.85rem;">
        Shortcuts: <b>Ctrl/âŒ˜+K</b> opens Â· <b>/</b> opens Â· <b>Esc</b> closes Â· <b>Enter</b> runs first match
      </div>
    </div>
  </div>

  <input type="file" id="importFile" accept=".txt" style="display:none" />

  <script>
    (function(){
      "use strict";

      // ===== Versioned keys (prevents weird breakage across updates) =====
      const V = "v4";
      const K = {
        NOTES: "cc_notes_" + V,
        NOTES_TIME: "cc_notes_time_" + V,
        PINS: "cc_pins_" + V,
        MISS: "cc_missions_" + V,
        HISTORY: "cc_history_" + V,
        TILES: "cc_tiles_" + V,
        FOCUS: "cc_focus_" + V
      };

      // ===== Helpers =====
      const $ = (id)=>document.getElementById(id);
      const esc = (s)=>String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
      const nowStamp = ()=> new Date().toLocaleString();
      const safeParse = (raw, fallback)=>{ try{ return JSON.parse(raw); } catch(e){ return fallback; } };
      const openTab = (url)=> window.open(url, "_blank", "noopener,noreferrer");

      // ===== UI =====
      const app = $("app");
      const jsBadge = $("jsBadge");
      const clockBadge = $("clockBadge");
      const statusDot = $("statusDot");
      const statusText = $("statusText");

      function setJS(ok, msg){
        jsBadge.textContent = ok ? "JS: OK" : ("JS: " + (msg||"FAIL"));
        statusDot.className = "dot" + (ok ? "" : " bad");
        statusText.textContent = ok ? "Online" : "Degraded";
      }

      function tick(){
        const d = new Date();
        clockBadge.textContent = "Time: " + d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      }

      // ===== Search + Bangs =====
      const qEl = $("q");
      const engineEl = $("engine");

      const engines = {
        google:   q=>`https://www.google.com/search?q=${encodeURIComponent(q)}`,
        ddg:      q=>`https://duckduckgo.com/?q=${encodeURIComponent(q)}`,
        brave:    q=>`https://search.brave.com/search?q=${encodeURIComponent(q)}`,
        reddit:   q=>`https://www.reddit.com/search/?q=${encodeURIComponent(q)}`,
        youtube:  q=>`https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`,
        github:   q=>`https://github.com/search?q=${encodeURIComponent(q)}`,
        wikipedia:q=>`https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(q)}`
      };

      const bangs = {
        "!g":"google", "!ddg":"ddg", "!br":"brave",
        "!r":"reddit", "!yt":"youtube", "!gh":"github", "!w":"wikipedia"
      };

      function resolveSearch(raw){
        let text = (raw||"").trim();
        if(!text) return null;

        const parts = text.split(/\s+/);
        const maybe = parts[0].toLowerCase();
        if(bangs[maybe]){
          const eng = bangs[maybe];
          parts.shift();
          text = parts.join(" ").trim();
          if(!text) return null;
          return { engine: eng, query: text };
        }
        return { engine: engineEl.value, query: text };
      }

      function getHistory(){ return safeParse(localStorage.getItem(K.HISTORY)||"[]", []); }
      function saveHistory(arr){ localStorage.setItem(K.HISTORY, JSON.stringify(arr.slice(0, 18))); }

      function addHistory(item){
        const h = getHistory();
        const key = item.engine + "|" + item.query;
        const filtered = h.filter(x => (x.engine+"|"+x.query) !== key);
        filtered.unshift({engine:item.engine, query:item.query, t: Date.now()});
        saveHistory(filtered);
        renderHistory();
      }

      function renderHistory(){
        const box = $("historyList");
        const h = getHistory();
        box.innerHTML = "";
        if(!h.length){
          box.innerHTML = `<div class="item"><div><div class="itemTitle">No history yet</div><div class="itemMeta">Search anything to populate this list.</div></div></div>`;
          return;
        }
        h.forEach((x, i)=>{
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div>
              <div class="itemTitle">${esc(x.query)}</div>
              <div class="itemMeta">${esc(x.engine)} Â· Open reruns it</div>
            </div>
            <div class="itemBtns">
              <button class="btn secondary" type="button" data-hopen="${i}">Open</button>
              <button class="btn danger" type="button" data-hdel="${i}">Del</button>
            </div>
          `;
          box.appendChild(div);
        });

        box.querySelectorAll("[data-hopen]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const i = Number(b.getAttribute("data-hopen"));
            const item = getHistory()[i];
            if(!item) return;
            openTab(engines[item.engine](item.query));
          });
        });
        box.querySelectorAll("[data-hdel]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const i = Number(b.getAttribute("data-hdel"));
            const h2 = getHistory();
            h2.splice(i,1);
            saveHistory(h2);
            renderHistory();
          });
        });
      }

      function doSearch(){
        const resolved = resolveSearch(qEl.value);
        if(!resolved){ qEl.focus(); return; }
        addHistory(resolved);
        openTab(engines[resolved.engine](resolved.query));
      }

      // ===== Launch Tiles (editable) =====
      function defaultTiles(){
        return [
          {name:"WEATHER COMMAND CENTER", tag:"separate ops page (build next)", url:"https://cybercrow111.github.io/weather-command/"},
          {name:"NWS Radar", tag:"live radar", url:"https://radar.weather.gov/"},
          {name:"Caltrans QuickMap", tag:"closures + traffic", url:"https://quickmap.dot.ca.gov/"},
          {name:"511 California", tag:"incidents", url:"https://www.511ca.org/"},
          {name:"FEMA Flood Maps", tag:"hazard lookup", url:"https://msc.fema.gov/portal/home"},
          {name:"ChatGPT", tag:"AI core", url:"https://chat.openai.com/"},
          {name:"GitHub Repo", tag:"forge", url:"https://github.com/CyberCrow111/sentinel-anchor"},
          {name:"Notebook / Docs", tag:"google drive", url:"https://drive.google.com/"},
          {name:"YouTube", tag:"learning", url:"https://www.youtube.com/"}
        ];
      }
      function getTiles(){
        const raw = localStorage.getItem(K.TILES);
        return raw ? safeParse(raw, defaultTiles()) : defaultTiles();
      }
      function saveTiles(t){ localStorage.setItem(K.TILES, JSON.stringify(t)); }
      function renderTiles(){
        const tiles = getTiles();
        const box = $("quickTiles");
        box.innerHTML = "";
        tiles.forEach((t)=>{
          const a = document.createElement("a");
          a.className = "tile";
          a.href = t.url || "#";
          a.target = "_blank";
          a.rel = "noopener";
          a.innerHTML = `<span>${esc(t.name||"Tile")}</span><span class="tag">${esc(t.tag||"")}</span>`;
          a.addEventListener("click", (e)=>{
            if(!t.url){ e.preventDefault(); toast("No URL set"); }
          });
          box.appendChild(a);
        });
      }
      function editTiles(){
        const tiles = getTiles();
        const pick = prompt(
`Edit Tiles:
Type a number to edit (1-${tiles.length})
Type "add" to add new
Type "reset" to restore defaults`,
          ""
        );
        if(pick === null) return;
        const p = pick.trim().toLowerCase();

        if(p === "reset"){
          localStorage.removeItem(K.TILES);
          renderTiles();
          toast("Tiles reset");
          return;
        }
        if(p === "add"){
          const name = prompt("Tile name:", "New Tool");
          if(name===null) return;
          const url = prompt("URL (include https://):", "https://");
          if(url===null) return;
          const tag = prompt("Short tag:", "tool");
          if(tag===null) return;
          tiles.push({name:name.trim(), url:url.trim(), tag:tag.trim()});
          saveTiles(tiles);
          renderTiles();
          toast("Tile added");
          return;
        }
        const idx = Number(p) - 1;
        if(Number.isNaN(idx) || idx < 0 || idx >= tiles.length){
          toast("Invalid choice");
          return;
        }
        const t = tiles[idx];
        const name = prompt("Tile name:", t.name||"");
        if(name===null) return;
        const url = prompt("URL (include https://):", t.url||"");
        if(url===null) return;
        const tag = prompt("Short tag:", t.tag||"");
        if(tag===null) return;
        tiles[idx] = {name:name.trim(), url:url.trim(), tag:tag.trim()};
        saveTiles(tiles);
        renderTiles();
        toast("Tile saved");
      }

      // ===== Missions =====
      function defaultMissions(){
        return [
          {t:"Build Weather Command Center", d:"Create new repo: weather-command â†’ link already placed in tiles"},
          {t:"Daily log", d:"Notes â†’ Daily â†’ 3 bullets"},
          {t:"Pin your key links", d:"Add Victoria / important hubs / receipts etc"}
        ];
      }
      function getMissions(){
        const raw = localStorage.getItem(K.MISS);
        return raw ? safeParse(raw, defaultMissions()) : defaultMissions();
      }
      function saveMissions(m){ localStorage.setItem(K.MISS, JSON.stringify(m)); }
      function renderMissions(){
        const m = getMissions();
        const box = $("missionList");
        box.innerHTML = "";
        m.forEach((x, i)=>{
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div>
              <div class="itemTitle">${esc(x.t||"Mission")}</div>
              <div class="itemMeta">${esc(x.d||"")}</div>
            </div>
            <div class="itemBtns">
              <button class="btn secondary" type="button" data-medit="${i}">Edit</button>
              <button class="btn danger" type="button" data-mdel="${i}">Del</button>
            </div>
          `;
          box.appendChild(div);
        });

        box.querySelectorAll("[data-medit]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const i = Number(b.getAttribute("data-medit"));
            const m2 = getMissions();
            const x = m2[i];
            const t = prompt("Mission title:", x.t||"");
            if(t===null) return;
            const d = prompt("Details:", x.d||"");
            if(d===null) return;
            m2[i] = {t:t.trim(), d:d.trim()};
            saveMissions(m2);
            renderMissions();
            toast("Mission saved");
          });
        });
        box.querySelectorAll("[data-mdel]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const i = Number(b.getAttribute("data-mdel"));
            const m2 = getMissions();
            m2.splice(i,1);
            saveMissions(m2);
            renderMissions();
            toast("Mission deleted");
          });
        });
      }
      function addMission(){
        const t = prompt("Mission title (short):", "New mission");
        if(t===null) return;
        const d = prompt("Details (optional):", "");
        if(d===null) return;
        const m = getMissions();
        m.push({t:t.trim(), d:d.trim()});
        saveMissions(m);
        renderMissions();
        toast("Mission added");
      }
      function clearMissions(){
        if(!confirm("Clear missions on this device?")) return;
        localStorage.removeItem(K.MISS);
        renderMissions();
        toast("Missions cleared");
      }

      // ===== Pinned Links =====
      function defaultPins(){
        return [
          {name:"Weather Command Center", url:"https://cybercrow111.github.io/weather-command/", note:"(build next)"},
          {name:"Sentinel Anchor Repo", url:"https://github.com/CyberCrow111/sentinel-anchor", note:"forge"},
          {name:"Sentinel Anchor Live", url: window.location.href, note:"artifact"}
        ];
      }
      function getPins(){
        const raw = localStorage.getItem(K.PINS);
        return raw ? safeParse(raw, defaultPins()) : defaultPins();
      }
      function savePins(p){ localStorage.setItem(K.PINS, JSON.stringify(p)); }
      function renderPins(){
        const pins = getPins();
        const box = $("pinList");
        box.innerHTML = "";
        pins.forEach((p, i)=>{
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div>
              <div class="itemTitle">${esc(p.name||"Link")}</div>
              <div class="itemMeta">${esc(p.url || p.note || "No URL set")}</div>
            </div>
            <div class="itemBtns">
              <button class="btn secondary" type="button" data-popen="${i}">Open</button>
              <button class="btn secondary" type="button" data-pedit="${i}">Edit</button>
              <button class="btn danger" type="button" data-pdel="${i}">Del</button>
            </div>
          `;
          box.appendChild(div);
        });

        box.querySelectorAll("[data-popen]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const i = Number(b.getAttribute("data-popen"));
            const p = getPins()[i];
            if(!p || !p.url){ toast("No URL set"); return; }
            openTab(p.url);
          });
        });
        box.querySelectorAll("[data-pedit]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const i = Number(b.getAttribute("data-pedit"));
            const pins2 = getPins();
            const p = pins2[i] || {name:"", url:"", note:""};
            const name = prompt("Link name:", p.name||"");
            if(name===null) return;
            const url = prompt("URL (include https://):", p.url||"https://");
            if(url===null) return;
            const note = prompt("Short note (optional):", p.note||"");
            if(note===null) return;
            pins2[i] = {name:name.trim(), url:url.trim(), note:note.trim()};
            savePins(pins2);
            renderPins();
            toast("Link saved");
          });
        });
        box.querySelectorAll("[data-pdel]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const i = Number(b.getAttribute("data-pdel"));
            const pins2 = getPins();
            pins2.splice(i,1);
            savePins(pins2);
            renderPins();
            toast("Link deleted");
          });
        });
      }
      function addPin(){
        const pins = getPins();
        pins.push({name:"New Link", url:"", note:"tap Edit"});
        savePins(pins);
        renderPins();
        toast("Link added");
      }
      function clearPins(){
        if(!confirm("Clear all pinned links on this device?")) return;
        localStorage.removeItem(K.PINS);
        renderPins();
        toast("Links cleared");
      }

      // ===== Notes =====
      const notesEl = $("notes");
      const noteState = $("noteState");
      const lastSaved = $("lastSaved");
      let saveTimer = null;

      function setNoteState(s){ noteState.textContent = s; }
      function loadNotes(){
        const txt = localStorage.getItem(K.NOTES) || "";
        const t = localStorage.getItem(K.NOTES_TIME) || "â€”";
        notesEl.value = txt;
        lastSaved.textContent = t;
        setNoteState("Ready");
      }
      function saveNotes(){
        try{
          const t = nowStamp();
          localStorage.setItem(K.NOTES, notesEl.value);
          localStorage.setItem(K.NOTES_TIME, t);
          lastSaved.textContent = t;
          setNoteState("Saved");
        }catch(e){
          setNoteState("Save failed");
        }
      }
      function scheduleSave(){
        setNoteState("Savingâ€¦");
        clearTimeout(saveTimer);
        saveTimer = setTimeout(saveNotes, 350);
      }
      function stamp(){
        insertAtCursor(notesEl, `\n[${nowStamp()}] `);
        scheduleSave();
      }
      function daily(){
        const d = new Date().toLocaleDateString();
        const tpl =
`\n[Daily Log â€” ${d}]
Mission:
Wins:
Problems:
Next:
---\n`;
        insertAtCursor(notesEl, tpl);
        scheduleSave();
      }
      function exportNotes(){
        const content = notesEl.value || "";
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
        const blob = new Blob([content], {type:"text/plain"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `sentinel-notes-${stamp}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast("Exported");
      }
      function importNotes(){ $("importFile").click(); }
      $("importFile").addEventListener("change", async (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const text = await file.text();
        notesEl.value = text;
        saveNotes();
        toast("Imported");
        e.target.value = "";
      });
      function clearNotes(){
        if(!confirm("Clear notes on this device? Export first if needed.")) return;
        notesEl.value = "";
        localStorage.removeItem(K.NOTES);
        localStorage.removeItem(K.NOTES_TIME);
        lastSaved.textContent = "â€”";
        setNoteState("Cleared");
        toast("Notes cleared");
      }
      function insertAtCursor(el, text){
        const start = el.selectionStart || 0;
        const end = el.selectionEnd || 0;
        el.value = el.value.slice(0,start) + text + el.value.slice(end);
        const pos = start + text.length;
        el.setSelectionRange(pos,pos);
        el.focus();
      }

      // ===== Focus mode =====
      function toggleFocus(){
        const on = !app.classList.contains("focus");
        if(on) app.classList.add("focus"); else app.classList.remove("focus");
        localStorage.setItem(K.FOCUS, on ? "1":"0");
        toast(on ? "Focus ON" : "Focus OFF");
      }
      function loadFocus(){
        if(localStorage.getItem(K.FOCUS)==="1") app.classList.add("focus");
      }

      // ===== Copy URL =====
      async function copyUrl(){
        const text = window.location.href;
        try{
          await navigator.clipboard.writeText(text);
          toast("Copied URL");
        }catch(e){
          const ta = document.createElement("textarea");
          ta.value = text; document.body.appendChild(ta);
          ta.select(); document.execCommand("copy");
          document.body.removeChild(ta);
          toast("Copied URL");
        }
      }

      // ===== Reset local =====
      function resetLocal(){
        if(!confirm("Reset local data (notes, pins, missions, tiles, history, focus) on THIS device?")) return;
        Object.values(K).forEach(k=>localStorage.removeItem(k));
        location.reload();
      }

      // ===== Command Palette =====
      const overlay = $("overlay");
      const cmdInput = $("cmdInput");
      const cmdList = $("cmdList");

      function showPalette(){
        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden","false");
        cmdInput.value = "";
        renderCommands("");
        setTimeout(()=>cmdInput.focus(), 25);
      }
      function hidePalette(){
        overlay.style.display = "none";
        overlay.setAttribute("aria-hidden","true");
      }

      const BASE_COMMANDS = [
        {name:"Search", desc:"Run search with current query", run:()=>doSearch()},
        {name:"Focus Mode", desc:"Toggle focus mode", run:()=>toggleFocus()},
        {name:"Edit Launch Tiles", desc:"Add/edit/reset quick launch tools", run:()=>editTiles()},
        {name:"Add Pin Link", desc:"Add a pinned link", run:()=>addPin()},
        {name:"Add Mission", desc:"Create a mission slot", run:()=>addMission()},
        {name:"Stamp Note", desc:"Insert timestamp in notes", run:()=>stamp()},
        {name:"Daily Template", desc:"Insert daily note template", run:()=>daily()},
        {name:"Export Notes", desc:"Download notes .txt", run:()=>exportNotes()},
        {name:"Import Notes", desc:"Load notes from .txt", run:()=>importNotes()},
        {name:"Weather Command Center", desc:"Open the separate weather ops page (repo build next)", run:()=>openTab("https://cybercrow111.github.io/weather-command/")},
        {name:"Radar (NWS)", desc:"Live radar", run:()=>openTab("https://radar.weather.gov/")},
        {name:"Roads (QuickMap)", desc:"Closures + traffic", run:()=>openTab("https://quickmap.dot.ca.gov/")},
        {name:"Copy URL", desc:"Copy this page URL", run:()=>copyUrl()},
        {name:"Repo (Forge)", desc:"Open GitHub repo", run:()=>openTab("https://github.com/CyberCrow111/sentinel-anchor")},
        {name:"Reset Local", desc:"Clear local data for this device", run:()=>resetLocal()}
      ];

      function renderCommands(filter){
        const f = (filter||"").trim().toLowerCase();
        const q = (qEl.value||"").trim();

        const smart = [];
        if(q){
          const r = resolveSearch(q);
          const qq = r ? r.query : q;
          smart.push(
            {name:`Search Google: ${qq}`, desc:"Run Google search for current query", run:()=>openTab(engines.google(qq))},
            {name:`Search GitHub: ${qq}`, desc:"Run GitHub search for current query", run:()=>openTab(engines.github(qq))},
            {name:`Search Reddit: ${qq}`, desc:"Run Reddit search for current query", run:()=>openTab(engines.reddit(qq))}
          );
        }

        const all = smart.concat(BASE_COMMANDS);
        const list = !f ? all : all.filter(c =>
          c.name.toLowerCase().includes(f) || (c.desc||"").toLowerCase().includes(f)
        );

        cmdList.innerHTML = "";
        list.slice(0, 28).forEach((c)=>{
          const div = document.createElement("div");
          div.className = "cmd";
          div.innerHTML = `<div><div class="cmdName">${esc(c.name)}</div><div class="cmdDesc">${esc(c.desc||"")}</div></div><div class="pill">Run</div>`;
          div.addEventListener("click", ()=>{ try{ c.run(); } finally { hidePalette(); } });
          cmdList.appendChild(div);
        });

        cmdInput.onkeydown = (e)=>{
          if(e.key === "Enter"){
            e.preventDefault();
            const first = list[0];
            if(first){ first.run(); hidePalette(); }
          }
        };
      }

      // ===== Toast =====
      let toastTimer=null;
      function toast(msg){
        clearTimeout(toastTimer);
        const old = jsBadge.textContent;
        jsBadge.textContent = msg;
        toastTimer = setTimeout(()=>jsBadge.textContent = old, 1400);
      }

      // ===== Bindings =====
      function bind(){
        $("btnSearch").addEventListener("click", doSearch);
        qEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); doSearch(); } });

        $("btnCommand").addEventListener("click", showPalette);
        $("btnClosePalette").addEventListener("click", hidePalette);
        overlay.addEventListener("click", (e)=>{ if(e.target === overlay) hidePalette(); });
        cmdInput.addEventListener("input", (e)=>renderCommands(e.target.value));

        $("btnFocus").addEventListener("click", toggleFocus);
        $("btnCopyUrl").addEventListener("click", copyUrl);
        $("btnLocalReset").addEventListener("click", resetLocal);

        $("btnStamp").addEventListener("click", stamp);
        $("btnDaily").addEventListener("click", daily);
        $("btnExport").addEventListener("click", exportNotes);
        $("btnImport").addEventListener("click", importNotes);
        $("btnClearNotes").addEventListener("click", clearNotes);

        $("btnAddPin").addEventListener("click", addPin);
        $("btnClearPins").addEventListener("click", clearPins);

        $("btnAddMission").addEventListener("click", addMission);
        $("btnClearMissions").addEventListener("click", clearMissions);

        $("btnClearHistory").addEventListener("click", ()=>{ localStorage.removeItem(K.HISTORY); renderHistory(); toast("History cleared"); });

        $("btnEditTiles").addEventListener("click", editTiles);

        $("btnOpenRepo").addEventListener("click", ()=>openTab("https://github.com/CyberCrow111/sentinel-anchor"));
        $("btnOpenSite").addEventListener("click", ()=>openTab(window.location.href));

        document.addEventListener("keydown", (e)=>{
          const k = e.key.toLowerCase();

          if((e.ctrlKey || e.metaKey) && k === "k"){
            e.preventDefault();
            showPalette();
          }
          if(k === "/" && !e.ctrlKey && !e.metaKey){
            const t = document.activeElement && document.activeElement.tagName;
            if(t !== "INPUT" && t !== "TEXTAREA"){
              e.preventDefault();
              showPalette();
            }
          }
          if(e.key === "Escape"){
            hidePalette();
          }
        });

        notesEl.addEventListener("input", scheduleSave);
      }

      function boot(){
        tick();
        setInterval(tick, 15000);

        loadFocus();
        renderTiles();
        renderMissions();
        renderPins();
        renderHistory();
        loadNotes();

        bind();
        setJS(true);
      }

      try{
        document.addEventListener("DOMContentLoaded", boot);
      }catch(e){
        setJS(false, "ERROR");
      }
      window.addEventListener("error", ()=>setJS(false, "ERROR"));
    })();
  </script>
</body>
  </html>
